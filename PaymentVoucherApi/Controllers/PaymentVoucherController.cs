using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using PaymentVoucherApi.DTO;
using PaymentVoucherApi.Services;

namespace PaymentVoucherApi.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class PaymentVoucherController : ControllerBase
    {
        private readonly ITokenService _tokenService;

        public PaymentVoucherController(ITokenService tokenService)
        {
            _tokenService = tokenService;
        }

        [HttpPost, Route("Login")]
        public async Task<IActionResult> GenerateToken([FromBody] LoginRequestDTO request)
        {
            if (string.IsNullOrWhiteSpace(request.Username) || string.IsNullOrWhiteSpace(request.Password))
                return BadRequest("Usuário e senha são obrigatórios.");

            var token = await _tokenService.GetTokenAsync(request.Username, request.Password);

            if (token == null)
                return Unauthorized("Falha ao autenticar no Keycloak.");

            return Ok(new { access_token = token });
        }

        [HttpGet, Route("Get-By-Purchase-Id/{purchaseId}")]
        [Authorize(Roles = "MicroserviceIntegrator")]
        public IActionResult ProtectedEndpoint(int purchaseId)
        {
            var pdfVazioBytes = new byte[]
                {
                0x25,0x50,0x44,0x46,0x2D,0x31,0x2E,0x34,0x0A,
                0x25,0xE2,0xE3,0xCF,0xD3,0x0A,
                0x31,0x20,0x30,0x20,0x6F,0x62,0x6A,0x0A,0x3C,0x3C,
                0x2F,0x54,0x79,0x70,0x65,0x20,0x2F,0x43,0x61,0x74,0x61,
                0x6C,0x6F,0x67,0x0A,0x2F,0x50,0x61,0x67,0x65,0x73,0x20,
                0x32,0x20,0x30,0x20,0x52,0x0A,0x3E,0x3E,0x0A,0x65,0x6E,
                0x64,0x6F,0x62,0x6A,0x0A,
                0x32,0x20,0x30,0x20,0x6F,0x62,0x6A,0x0A,0x3C,0x3C,
                0x2F,0x54,0x79,0x70,0x65,0x20,0x2F,0x50,0x61,0x67,0x65,
                0x73,0x0A,0x2F,0x4B,0x69,0x64,0x73,0x20,0x5B,0x33,0x20,
                0x30,0x20,0x52,0x5D,0x0A,0x3E,0x3E,0x0A,0x65,0x6E,0x64,
                0x6F,0x62,0x6A,0x0A,
                0x33,0x20,0x30,0x20,0x6F,0x62,0x6A,0x0A,0x3C,0x3C,
                0x2F,0x54,0x79,0x70,0x65,0x20,0x2F,0x50,0x61,0x67,0x65,
                0x0A,0x2F,0x50,0x61,0x72,0x65,0x6E,0x74,0x20,0x32,0x20,
                0x30,0x20,0x52,0x0A,0x3E,0x3E,0x0A,0x65,0x6E,0x64,0x6F,
                0x62,0x6A,0x0A,
                0x78,0x72,0x65,0x66,0x0A,
                0x30,0x20,0x33,0x0A,
                0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x20,0x36,0x35,
                0x35,0x33,0x35,0x0A,
                0x74,0x72,0x61,0x69,0x6C,0x65,0x72,0x0A,
                0x3C,0x3C,0x2F,0x52,0x6F,0x6F,0x74,0x20,0x31,0x20,0x30,
                0x20,0x52,0x0A,0x3E,0x3E,0x0A,
                0x73,0x74,0x61,0x72,0x74,0x78,0x72,0x65,0x66,0x0A,
                0x35,0x33,0x37,0x0A,
                0x25,0x25,0x45,0x4F,0x46,0x0A
                };

            var base64Pdf = Convert.ToBase64String(pdfVazioBytes);

            return Ok(new
            {
                IdPurchase = purchaseId,
                TypeFile = "Comprovante de pagamento",
                PdfBase64 = base64Pdf
            });
        }
    }
}
